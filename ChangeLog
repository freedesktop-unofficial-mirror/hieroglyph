2010-07-23  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgscanner.l (hg_scanner_attach_file): unlock the object
	if different file object is being attached.

	* hieroglyph/hgoperator.c (_hg_operator_real_not): implemented.

	* hieroglyph/hgvm.c (hg_vm_quark_set_attributes): new.
	(hg_vm_set_default_attributes): new.
	(hg_vm_setup): set certain attributes to the built-in values.
	(hg_vm_stack_dump): new.

	* hieroglyph/hgoperator.c (STACK_PUSH): set a default attribute.
	(STACK_PUSH_AS_IS): new.

	* hieroglyph/hgoperator.c (_hg_operator_real_private_forceput):
	fix a typo.
	(_hg_operator_real_private_forceput): raise /invalidaccess
	if no appropriate permissions.
	(_hg_operator_real_known): implemented.

	* hieroglyph/hgquark.h (hg_quark_set_access_bits): new.
	(hg_quark_get_type_name): new.

	* lib/hg_init.ps: create dictionaries.

	* hieroglyph/hgoperator.c (_hg_operator_real_private_forceput):
	implemented.

	* hieroglyph/hgvm.c (hg_vm_set_io): fix a typo.

	* hieroglyph/hgfile.h (HG_IS_QFILE): fix a typo.

	* hieroglyph/hgarray.h (HG_IS_QARRAY): fix a typo.

	* hieroglyph/hgoperator.c (_hg_operator_real_dict): implemented.

	* hieroglyph/hgvm.c (hg_vm_setup): add /systemdict, /globaldict and
	/$error into systemdict.

2010-07-22  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgvm.c (hg_vm_stepi): drop a object on the exec stack
	if success.

	* hieroglyph/hgoperator.c (_hg_operator_real_private_setglobal):
	implemented.

2010-07-21  Akira TAGOH  <akira@tagoh.org>

	* src/hgs/hgs.c: add an interpreter on CUI.

	* hieroglyph/hgoperator.c (DEFUNC_UNIMPLEMENTED_OPER):
	raise VMerror when invoking not-implemented operator.

	* hieroglyph/hgvm.c (hg_vm_quark_to_string): implemented.
	(hg_vm_dict_lookup): return a result exactly.

	* hieroglyph/hgscanner.l (YY_INPUT): read 1-byte only.

	* hieroglyph/hgquark.h (hg_quark_get_hash): new.

	* hieroglyph/hgdict.c (hg_dict_add): mask the access flags.
	(hg_dict_remove): likewise.
	(hg_dict_lookup): likewise.

	* hieroglyph/hgstring.c (_hg_object_string_initialize): delay
	to allocate the container to save the memory space
	in the real world.
	(_hg_string_maybe_expand): new.
	(hg_string_append_printf): new.

2010-07-20  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgquark.h (hg_quark_set_readable): new.
	(hg_quark_is_readable): new.
	(hg_quark_set_writable): new.
	(hg_quark_is_writable): new.

	* hieroglyph/hgmem.c (hg_mem_realloc): just invoke hg_mem_alloc
	if qdata is Qnil. behaving similarly to libc's realloc.

	* hieroglyph/hgname.h (HG_NAME): new.

	* hieroglyph/hgbool.h (HG_BOOL): new.

2010-07-17  Akira TAGOH  <akira@tagoh.org>

	* .gdbinit (hgquarkinfo): add a macro.

	* hieroglyph/hgobject.c (hg_object_copy): new.
	(hg_object_to_string): new.

2010-07-16  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgbtree.c (hg_btree_find): avoid unnecessary warnings.

	* hieroglyph/hgquark.h (hg_quark_has_same_mem_id): new.
	cleanup.
	(_hg_quark_type_bit_shift): renamed.
	(_hg_quark_type_bit_set_bits): changed API to not being confused.
	(hg_quark_set_executable): likewise.
	(hg_quark_set_mem_id): new.

	* hieroglyph/hgscanner.l: create the object with HG_TYPE_EVAL_NAME for
	//blahblahblah and set the exec bit.

	* hieroglyph/hgname.h (HG_QEVALNAME): new.
	(HG_IS_QEVALNAME): new.

	* hieroglyph/hgname.c (hg_name_lookup): allow HG_TYPE_EVAL_NAME as well.

	* hieroglyph/hgstring.c (hg_string_new): don't try to unlock the object
	if Qnil.
	(hg_string_new_with_value): likewise.

	* hieroglyph/hgobject.c (_hg_object_new): exit the function immediately
	if the memory allocation failed.

	* hieroglyph/hgfile.c (_hg_file_io_real_file_open): fix a typo.
	(hg_file_new_with_vtable): don't try to unlock the object if Qnil.

	* hieroglyph/hgdict.c (hg_dict_new): fix a typo.
	(hg_dict_add): likewise.
	(hg_dict_remove): likewise.
	(hg_dict_lookup): likewise.

	* hieroglyph/hgbtree-private.h (HG_BTREE_NODE_LOCK): initialize
	values to void segfault when failing the lock.

	* hieroglyph/hgmem.c (hg_mem_new_with_allocator): check the id here.
	(hg_mem_alloc): set the mem id to the quark.
	(hg_mem_realloc): likewise.
	(hg_mem_free): check the mem id.
	(hg_mem_lock_object): likewise.
	(hg_mem_unlock_object): likewise.

	* hieroglyph/hgallocator.c (_hg_allocator_initialize): revert
	the change.
	(_hg_allocator_alloc): likewise.
	(_hg_allocator_lock_object): likewise.
	(_hg_allocator_unlock_object): likewise.

2010-07-14  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgoperator.[ch]: new.

2010-07-13  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgfile.c (_hg_file_io_real_buffered_close):
	add more finalization.
	(hg_file_new_with_string): lock object since it's referring
	the real object.

	* hieroglyph/hgscanner.l (hg_scanner_attach_file): restore a lineno.
	(hg_scanner_scan): save a lineno.

	* hieroglyph/hgfile.c (hg_file_set_lineno): new.
	(hg_file_get_lineno): new.
	(hg_file_get_position): new.

2010-07-12  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgmem.c (hg_mem_new_with_allocator): set a mem id.
	(hg_mem_get_id): new.

	* hieroglyph/hgallocator.c (_hg_allocator_initialize): set a mem id.
	(_hg_allocator_alloc): likewise.
	(_hg_allocator_lock_object): likewise.
	(_hg_allocator_unlock_object): likewise.

	* hieroglyph/hgscanner.l: check the overflow in ASCII85.

2010-07-10  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgstack.c (hg_stack_free): new.

2010-07-09  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgfile.c (hg_file_get_io_type): make it public.

	* hieroglyph/hgfile.h (HG_IS_FILE): new.

	* hieroglyph/hgscanner.l: add a lexical scanner.

	* hieroglyph/hgquark.h (hg_quark_set_lookup): new.
	(hg_quark_is_lookup_needed): new.

	* hieroglyph/hgarray.h (HG_IS_ARRAY): new.

	* hieroglyph/hgarray.c (_hg_object_array_initialize): delay to
	allocate the container to save memory space in the real world.
	(_hg_array_maybe_expand): new.
	(hg_array_set): update.
	(hg_array_get): update.
	(hg_array_insert): update.

2010-07-08  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgstring.c (hg_string_new_with_value): allow the negative
	value for unsure sized string.

	* hieroglyph/hgfile.c (_hg_file_get_io_type): allow the beggining of
	'%' in the filename.
	(hg_file_new_with_string): fix a typo.

	* hieroglyph/hgquark.h (_hg_quark_type_bit_validate_bits): fix
	masking unexpected bits.
	(hg_quark_set_executable): new.
	(hg_quark_is_executable): new.

2010-07-07  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgfile.h (HG_FILE_INIT): initialize the string object.

	* hieroglyph/hgfile.c (_hg_file_io_real_stdin_open): fix a typo.
	(_hg_file_io_real_stdout_open): likewise.
	(_hg_file_io_real_stderr_open): likewise.
	(_hg_file_io_real_file_open): likewise.
	(_hg_file_io_real_buffered_open): likewise.

	* hieroglyph/hgstring.h (HG_QSTRING): fix a typo.

	* hieroglyph/hgstring.c (_hg_object_string_initialize): allow
	0-sized string allocation.

	* hieroglyph/hgreal.h (HG_REAL): new.
	(HG_IS_QREAL): new.
	(HG_REAL_EQUAL): new.
	(HG_REAL_IS_ZERO): new.
	(hg_real_convert_to_native): new.

	* hieroglyph/hgint.h (HG_INT): new.

	* hieroglyph/hgstring.h (HG_STRING_INIT): new.

	* hieroglyph/hgstack.h (HG_STACK_INIT): new.

	* hieroglyph/hgfile.h (HG_FILE_INIT): new.

	* hieroglyph/hgdict.h (HG_DICT_INIT): new.

	* hieroglyph/hgarray.h (HG_ARRAY_INIT): new.

	* hieroglyph/hgobject.c (hg_object_register): new.

2010-07-06  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgfile.[ch]: new.

2010-07-05  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgmem.h (hg_mem_lock_object_with_gerror): new.
	(HG_MEM_LOCK): new macro.
	(hg_return_val_with_gerror_if_lock_fail): new macro.
	(hg_return_with_gerror_if_lock_fail): new macro.
	(hg_return_val_if_lock_fail): new macro.
	(hg_return_if_lock_fail): new macro.

2010-07-02  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgstack.[ch]: new.

	* hieroglyph/hgdict.[ch]: new.

	* hieroglyph/hgbtree.c (hg_btree_remove): return a value
	if the item was removed or not.

	* hieroglyph/hgstring.h (HG_QSTRING): new.
	(HG_IS_QSTRING): new.

	* hieroglyph/hgnull.h (HG_IS_QNULL): new.

	* hieroglyph/hgname.h (HG_IS_QNAME): new.

	* hieroglyph/hgmark.h (HG_IS_QMARK): new.

	* hieroglyph/hgint.h (HG_IS_QINT): new.

	* hieroglyph/hgbool.h (HG_IS_QBOOL): new.

	* hieroglyph/hgobject.c (hg_object_init): initialize the array object.

	* hieroglyph/hgarray.[ch]: new.

	* hieroglyph/hgstring.c (_hg_object_string_initialize): fail
	the initialization if allocation failed.

	* hieroglyph/Makefile.am (hg_private_headers): add hgbtree-private.h

2010-07-01  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgname.[ch]: revised a lot.

	* hieroglyph/hgquark.h (hg_quark_new): drop the higher bits
	to avoid putting the garbage.

	* hieroglyph/hgencoding.c (hg_encoding_init): returns TRUE
	if the hash table is already initialized.

	* hieroglyph/hgbtree.[ch]: new.

	* hieroglyph/hgerror.h (_hg_gerror_on_fail): new.
	(hg_return_with_gerror_if_fail): new.
	(hg_return_val_with_gerror_if_fail): new.

	* hieroglyph/hgerror.c (hg_error_quark): new.

	* hieroglyph/hgallocator.c (_hg_allocator_bitmap_alloc):
	add more debuginfo message.

2010-06-29  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgmem.c (hg_mem_lock_object): ignore Qnil.
	(hg_mem_unlock_object): likewise.
	(hg_mem_free): ignore Qnil.

	* hieroglyph/hgobject.c (hg_object_new): unlock the object
	if no referrer.

	* hieroglyph/hgstring.c (hg_string_new): likewise.
	(hg_string_new_with_value): likewise.
	(hg_string_get_cstr): likewise.

2010-06-28  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgobject.c (hg_object_init): initialize the string object.

	* hieroglyph/hgstring.[ch]: new.

	* hieroglyph/hgallocator.c (_hg_allocator_realloc): unlock the object
	when any referrer found.
	(_hg_allocator_alloc): keep a concistency on the behaviour of
	the lock count.
	(_hg_allocator_realloc): likewise.

	* tests/hgallocator.c (test_realloc): don't pop up the unnecessary
	backtrace.

	* tests/hgencoding.c (test_hg_encoding_init): likewise.
	(test_hg_encoding_get_system_encoding_name): likewise.

	* hieroglyph/hgobject.c (hg_object_new): don't invoke
	the initialization function when failing allocating the object.
	(hg_object_new): fail if the initialization fails.

	* hieroglyph/hgallocator.c (_hg_allocator_realloc): not fail
	when lock_count is less than 2. it's still likely when locking
	the object in the object.
	(_hg_allocator_realloc): unlock the object when the lock_count is 2.

2010-06-24  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgreal.h (hg_real_convert_from_native): new.
	(HG_QREAL): new.

	* hieroglyph/hgmem.c (hg_mem_realloc): new.

	* hieroglyph/hgallocator.c (_hg_allocator_bitmap_alloc):
	Fix the unexpected marking issue.
	(_hg_allocator_bitmap_realloc): new.
	(_hg_allocator_bitmap_free): mutex-lock when clearing the bitmaps.
	(_hg_allocator_realloc): new.
	(_hg_allocator_lock_object): mutex-lock to avoid the race-condition
	with realloc.

2010-06-22  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgerror.c (hg_get_stacktrace): trivial fix to get rid of
	the unnecessary trace log.

2010-06-08  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgobject.[ch]: clean up.

	* hieroglyph/hgquark.h (hg_type_is_simple): new.
	(hg_quark_get_value): new.

	* hieroglyph/hgallocator.c: trivial change to keep consistency between
	Qnil and HG_QNULL.

2010-06-05  Akira TAGOH  <akira@tagoh.org>

	Update the header files that provides the simple object to be based on
	hg_quark_t rather than hg_object_t.

	* hieroglyph/hgbool.h (HG_QBOOL): new.

	* hieroglyph/hgint.h (HG_QINT): new.

	* hieroglyph/hgmark.h (HG_QMARK): new.

	* hieroglyph/hgnull.h (HG_QNULL): new.

	* hieroglyph/hgquark.h: add more macros and polish some.

2010-05-29  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgquark.h: new.

2010-05-27  Akira TAGOH  <akira@tagoh.org>

	* tests/hgname.c: add testcases.

	* hieroglyph/hgname.c (_hg_object_name_new): Fix a typo.

	* hieroglyph/hgobject.c (_hg_object_new): add the object type to
	the quark.
	(hg_object_init): add the name object vtable.
	(hg_object_init): initialize the encodings.

	* hieroglyph/hgmem.c (hg_mem_free): get rid of the unnecessary bits.
	(hg_mem_lock_object): likewise.
	(hg_mem_unlock_object): likewise.

	* tests/hgnull.c: add testcases.

	* tests/hgmark.c: add testcases.

	* hieroglyph/hgnull.h (hg_object_null_new): new macro.

	* hieroglyph/hgmark.h (hg_object_mark_new): new macro.

	* tests/hgint.c: add testcases.

	* hieroglyph/hgint.h (hg_object_int_new): new macro.

	* tests/hgbool.c: add testcases.

	* hieroglyph/hgtypes.h (Qnil): correct a typo.

	* hieroglyph/hgbool.h (hg_object_bool_new): new macro.

	* hieroglyph/hgallocator.c (_hg_allocator_initialize_and_lock_object):
	Fix wrong casting.

	* tests/hgencoding.c: add testcases.

	* hieroglyph/hgencoding.c (hg_encoding_lookup_system_encoding): 
	add more sanity check.

	* hieroglyph/hgname.[ch]: new.

	* hieroglyph/hgobject.c (hg_object_new): API change to make this
	comfortable for others.

	* hieroglyph/hgencoding.[ch]: new.

	* hieroglyph/hgtypes.h: add hg_system_encoding_t type.

2010-05-26  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgobject.c (hg_object_new): align the preallocated size.
	(hg_object_init): add missing the object vtables initialization.

2010-05-25  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgobject.h (HG_DEFINE_VTABLE): add new macro.

	* hieroglyph/hgnull.[ch]: new.

	* hieroglyph/hgmark.[ch]: new.

	* hieroglyph/hgbool.[ch]: new.

	* hieroglyph/hgint.[ch]: new.

	* hieroglyph/hgobject.[ch]: new.

	* hieroglyph/hgallocator.c: get rid of the unnecessary error check.

	* hieroglyph/hgallocator-private.h (hg_get_allocated_object):
	new macro.
	(hg_get_allocator_block): new macro.

2010-05-24  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgallocator.c (_hg_allocator_alloc): add ret argument to
	be able to set the real address.
	(_hg_allocator_alloc): don't unlock the object.
	(_hg_allocator_lock_internal_object): new to get
	the hg_allocator_block_t object.

	* hieroglyph/hgtypes.h: extend hg_quark_t to 64bit.

	* hieroglyph/hgmem.c (hg_mem_lock_object, hg_mem_unlock_object):
	add missing functions.

	* hieroglyph/hgerror.h (hg_stacktrace): Output to the glib log
	instead of stderr directly.

	* hieroglyph/hgallocator.c (_hg_allocator_bitmap_alloc): Fix a typo.
	(_hg_allocator_bitmap_free): Fix a typo.
	(_hg_allocator_alloc): Fix a typo.

2010-05-23  Akira TAGOH  <akira@tagoh.org>

	* hieroglyph/hgallocator.c: Drop hg_mem_t dependencies.

	* hieroglyph/hgallocator-private.h: new.

	* hieroglyph/Makefile.am (LIBS): Add missing library.

	* Makefile.am (SUBDIRS): Add tests.

2010-05-21  Akira TAGOH  <akira@tagoh.org>

	* hgallocator.[ch]: Revised.

	* hgerror.[ch]: Revised.

	* hgmacros.h: Revised.

	* hgmem-private.h: Revised.

	* hgmem.[ch]: Revised.

	* hgtypes.h: Revised.

	* hgutils.[ch]: Revised.


